---
title: "Analysis of shark activity model"
author: "Koichi Ito"
date: "2018/9/4"
output: html_document
---

# Method

### equations and source code
About the used equation, see the document file "shark_activity_model_0904KI.docx". I changed the following points from Andy's version.

- The definition of moretality rate because in the old version it was unclear how the m_x and m_y affects the mortality rate.
- Add influence of prey speed on its foraging efficiency determined by parameter omega
- Alternative definition of prey and shark swim speed.

About the source code of functions used in this analysis, see the r file "shark_activity_functions.R".

```{r source code, echo=FALSE}
source(file = "shark_activity_functions.R")
```

### shark body temperature
Although most equations and parameters are same with the document, I changed the calculation of shark body temperature in the simulation. The equation of body temperature on the document depends on two parameters, r and theta, but I could not understand the realistic parameter values. Therefore, in the simulation I simply calculate the shark body temperature by using the iteration of the following equation.

$$ s_{t+1} = s_t + (w_t - s_t)/mass $$
  
where mass is a coefficient deteremined by the heat capacity and thermal conductivity of sharks. This definition is mathematically same with the origional equation (mass is derived from r and theta).

- calc.bodytemp function use this definition.
- calc.mass_for_bodytemp function can calculate the parameter mass from r ans theta.


Note: I found some bugs in calc.shark.temp function. Please take care following points if you use it.

1. the iteration (20 times) is sometimes insufficient.
2. Q calculation looks different from the original equation; 'sharkradius' outsied of log in the denominator should be 'sharkradius^2'.

### parameter values
We set the following parameters constant because cahnge of these values has same influence with changing other parameters.

- foraging efficiency of prey (alpha): no influence on optimal strategy as long as alpha is constant for t.
- basic mortality rate of prey (mb): just determine the scale of mx and my; mx/mb and my/mb have influences.
- average swim speed of prey (u0): just determine the scale of v; only relative speed (v/u0) has influence.
- cost of predation for predator (C): just determine the scale of lmax, lmin (althought smaller lmax&lmin also reduce the relative influence of 'my'). lmax and lmin define the predation efficiency.

In the following analysis, I used default parameter values defined in the table 1 in "shark_activity_model_0904KI.docx".

```{r constant_parameters, echo=FALSE}
#=== constant parameters ===
#set time
pi = acos(-1)
tnum = 24 # time of day
t = 1:tnum-0.5

# temperature of the water
t_w=15
wmin = 25
wmax = 30
watertemp = wmin+(wmax-wmin)*(cos(2*pi*(t-t_w)/length(t))+1)/2

# amount of food availability for prey
alpha = rep(1.0, length=tnum)
# baseline mortality for prey (should pay both for resting and foraging)
mb = 0.1	
# average prey swim speed
u0 = 1.0
# metabolic cost for predators when they go out for predation
C = rep(0.1, length=tnum)

```

### categorization of shark activity pattern
For categorizing the various shark-activity patterns, I divided one day into three time zone, i.e.,

- midnight (20<t<=4)
- beforenoon (4<t<=12)
- afternoon (12<t<=20)

I detected active peaks (continuously used duration) of predators and categorized their activity peaks based on these time zone, e.g.,

- active between t=15~19: active afternoon
- active between t=15~22: active from afternoon to midnight.
- active between t=15~22 and 7~9: active from afternoon to midnight and another peak in beforenoon.
- active between t=13~15 and 18-20: two active peaks in afternoon.
- active between t=19~13: active from late afternoon to early afternoon (i.e., rest in afternoon)

Note: in order to remove the influence of too short rest time (less than 3 hours), I used smoothing function before find activity peaks by calculating average of activity at neighbouring time. 

In the following analysis, I show the image plots based on the categorization described in above, in which the color meaning of plots are following.    
===base color===  
black	: no use  
white	: all use  
cyan		: from afternoon  to beforenoon (rest around noon)  
blue		: from afternoon  to mid-night  
red		: from beforenoon to mid-night (rest early morning)  
darkgreen	: beforenoon  
darkred	: afternoon  
darkblue: midnight  
purple	: late beforenoon to early beforenoon (rest befornoon)  
green: midnight to beforenoon (rest befornoon)  
yellowgreen	: late afternoon to early afternoon (rest afternoon)  
yellow	: beforenoon to afternoon (daytime)  

===spot color===  
darkgreen-circle : sub peak in beforenoon  
green-circle : sub peak in between midnight and beforenoon  

# Result

# Appendix

### key three factors
In this model, there are three factors which change the benefit/cost of foraging/predation among time step.

1. prey bodytemp = watertemp. Peak is at t=15. 
2. influence of light, which reduce the predation efficiency. Peak is at t=12.
3. difference of bodytemp between shark and prey. Peak is about t= 17~3, depend on sharks' bodymass (sharkradius).

Balance of these three factors determine the active time.

### no light influence and perfect safety during resting
First, let's consider a simple situation like the following.

- no light influence (l0=l1), i.e., predation efficiency is always same where predation rate just depends on the difference of swim speed.
- perfect safety of prey during resting (phi=0), i.e., predators cannot attack prey if they don't go out for foraging.

##### case1: influence of mx-my when omega>0 and beta=0
The folloing three graphs shows

1. body temperature and swimspeed of prey (blue) and shark (red)
2. results of activity with changing mx (predation by other predators) and my (predatin by sharks), 3. categorized activity with changing mx and my

```{r A1, echo = FALSE}

omega = 1.0
beta = 0.0
phi = 0.0
h = 1

# work out the shark's body temperature
#    mass is kind of the size of shark (like sharkradius)
#    I used this just for simplifying parameters
mass = 10 
sharktemp=calc.bodytemp(watertemp,mass) 
#bodytemp=calc.shark.temp(tnum,watertemp,sharkradius,skinthickness)

# prey immediately track temperature
uk = 0.2 #influence of bodytemp
U = u0 + uk*(watertemp-(wmax+wmin)/2)

# sharks track their own temperature
v0 = 1.4  #average swim speed (prey is always 1.0)
vk = 0.2 #influence of bodytemp
V = v0 + vk*(sharktemp-(wmax+wmin)/2)

# calc light effect, or predation efficiency
#    e.g., in muddy (inclear) water this value will increase?
l0 = 1.0
l1 = 1.0
L = calc.light_effect(t,l0,l1)

plot.assumption(t, watertemp, sharktemp, V, U, L)


par(mfrow=c(5,5),mex=0.4)
for(my in rev(seq(0.0,1.5,length=5))){
for(mx in seq(0.0,1.5,length=5)){
	Ans = tss_probforage_energygain_optimize_linear(V, U, alpha, C, L, my, phi, omega, beta, h, mb,mx)
	plot.sim_result(Ans,bquote(list('m'['x']==.(mx),'m'['y']==.(my))))
}
}


par(mfrow=c(1,1))
grid = 51
no = matrix(0,grid,grid)
x.ax = seq(0,2,length=grid)
y.ax = seq(0,2,length=grid)

mx = 1.0
my = 1.0
for(y in 1:length(y.ax)){
	for(x in 1:length(x.ax)){
		mx = x.ax[x]
		my = y.ax[y]
		Ans = tss_probforage_energygain_optimize_linear(V, U, alpha, C, L, my, phi, omega, beta, h, mb,mx)
		no[x,y] = allpeak_no.sim_result(Ans,0.0)
		#	plot.sim_result(Ans,"")
	}
}

mode = allpeak_no.mode(no)
allpeak_no.image(x.ax,y.ax,mode,xlab="mx",ylab="my")
allpeak_no.point(x.ax,y.ax,mode,cex=0.5)

```

When beta=0, predator's swim speed has no influence and so the difference among time step is only the first factor, i.e., influence of prey bodytemp on the foraging efficiency. In such cases, prey forage when their foraging performance is high (i.e., around t=15). When the predation risk is high (large mx and my), they reduce total foraging time so the active time becomes shorter (in bottom-left side prey are active all time, but in top or right side prey are active only for 8~15 hours).

Because predators also follow the prey's activity, the shark activity is mostly same with prey activity, i.e., predation for whole day when mx and my are small (white region), otherwise predation from beforenoon to mid-night (red region) or afternoon (dark red region).

##### case2: influence of mx-my when omega=0 and beta>0

```{r A2, echo = FALSE}

omega = 0.0
beta = 1.0
phi = 0.0
h = 1

# work out the shark's body temperature
#    mass is kind of the size of shark (like sharkradius)
#    I used this just for simplifying parameters
mass = 10 
sharktemp=calc.bodytemp(watertemp,mass) 
#bodytemp=calc.shark.temp(tnum,watertemp,sharkradius,skinthickness)

# prey immediately track temperature
uk = 0.2 #influence of bodytemp
U = u0 + uk*(watertemp-(wmax+wmin)/2)

# sharks track their own temperature
v0 = 1.4  #average swim speed (prey is always 1.0)
vk = 0.2 #influence of bodytemp
V = v0 + vk*(sharktemp-(wmax+wmin)/2)

# calc light effect, or predation efficiency
#    e.g., in muddy (inclear) water this value will increase?
l0 = 1.0
l1 = 1.0
L = calc.light_effect(t,l0,l1)

#plot.assumption(t, watertemp, sharktemp, V, U, L)

x.seq = seq(0.0,1.5,length=5)
y.seq = seq(0.0,0.75,length=5)
par(mfrow=c(5,5),mex=0.4)
for(my in rev(y.seq)){
for(mx in x.seq){
	Ans = tss_probforage_energygain_optimize_linear(V, U, alpha, C, L, my, phi, omega, beta, h, mb,mx)
	plot.sim_result(Ans,bquote(list('m'['x']==.(mx),'m'['y']==.(my))))
}
}


par(mfrow=c(1,1))
grid = 51
no = matrix(0,grid,grid)
x.ax = seq(0,2,length=grid)
y.ax = seq(0,1,length=grid)

mx = 1.0
my = 1.0
for(y in 1:length(y.ax)){
	for(x in 1:length(x.ax)){
		mx = x.ax[x]
		my = y.ax[y]
		Ans = tss_probforage_energygain_optimize_linear(V, U, alpha, C, L, my, phi, omega, beta, h, mb,mx)
		no[x,y] = allpeak_no.sim_result(Ans,0.0)
		#	plot.sim_result(Ans,"")
	}
}

mode = allpeak_no.mode(no)
allpeak_no.image(x.ax,y.ax,mode,xlab="mx",ylab="my")
allpeak_no.point(x.ax,y.ax,mode,cex=0.5)

```

When omega=0, prey's swim speed has no influence on its foraging efficiency so the difference among time step is only the second factor, i.e., risk of predation. In such cases, prey forage when predation risk is low (i.e., difference of swim speed is small, in this case around t=14; see violet curve in the first figure).

Because predators cannot attack prey when v<u, which is in t=10~16. SO in this duration predators are inactive. When m_y (density of sharks for prey) is low, prey behave all time so predator go out for predation except around noon (from afternoon to beforenoon, cyan region) In high m_y, on the other hand, prey reduce its activity during midnight, so predators' actitivty becomes two peaks, early morning and evening (blue region with green dots).


As I described in above, predator are not active around noon because v<u in this time. The following figures are the case with higher predator swim speed (v0 = 1.4 -> 1.8).

```{r A2_2, echo = FALSE}

omega = 0.0
beta = 1.0
phi = 0.0
h = 1

# work out the shark's body temperature
#    mass is kind of the size of shark (like sharkradius)
#    I used this just for simplifying parameters
mass = 10
sharktemp=calc.bodytemp(watertemp,mass) 
#bodytemp=calc.shark.temp(tnum,watertemp,sharkradius,skinthickness)

# prey immediately track temperature
uk = 0.2 #influence of bodytemp
U = u0 + uk*(watertemp-(wmax+wmin)/2)

# sharks track their own temperature
v0 = 1.8  #average swim speed (prey is always 1.0)
vk = 0.2 #influence of bodytemp
V = v0 + vk*(sharktemp-(wmax+wmin)/2)

# calc light effect, or predation efficiency
#    e.g., in muddy (inclear) water this value will increase?
l0 = 1.0
l1 = 1.0
L = calc.light_effect(t,l0,l1)

plot.assumption(t, watertemp, sharktemp, V, U, L)

x.seq = seq(0.0,1.5,length=5)
y.seq = seq(0.0,1.5,length=5)
par(mfrow=c(5,5),mex=0.4)
for(my in rev(y.seq)){
for(mx in x.seq){
	Ans = tss_probforage_energygain_optimize_linear(V, U, alpha, C, L, my, phi, omega, beta, h, mb,mx)
	plot.sim_result(Ans,bquote(list('m'['x']==.(mx),'m'['y']==.(my))))
}
}


par(mfrow=c(1,1))
grid = 51
no = matrix(0,grid,grid)
x.ax = seq(0,2,length=grid)
y.ax = seq(0,2,length=grid)

mx = 1.0
my = 1.0
for(y in 1:length(y.ax)){
	for(x in 1:length(x.ax)){
		mx = x.ax[x]
		my = y.ax[y]
		Ans = tss_probforage_energygain_optimize_linear(V, U, alpha, C, L, my, phi, omega, beta, h, mb,mx)
		no[x,y] = allpeak_no.sim_result(Ans,0.0)
		#	plot.sim_result(Ans,"")
	}
}

mode = allpeak_no.mode(no)
allpeak_no.image(x.ax,y.ax,mode,xlab="mx",ylab="my")
allpeak_no.point(x.ax,y.ax,mode,cex=0.5)

```

In this case, v>u for all time, so preadtors activity becomes single peak, i.e., active in 
   red		: from beforenoon to mid-night (rest early morning)
   darkred	: afternoon
   yellow	: beforenoon to afternoon (daytime)


##### case3: influence of mx-my when omega>0 and beta>0

```{r A3, echo = FALSE}

omega = 1.0
beta = 1.0
phi = 0.0
h = 1

# work out the shark's body temperature
#    mass is kind of the size of shark (like sharkradius)
#    I used this just for simplifying parameters
mass = 10 
sharktemp=calc.bodytemp(watertemp,mass) 
#bodytemp=calc.shark.temp(tnum,watertemp,sharkradius,skinthickness)

# prey immediately track temperature
uk = 0.2 #influence of bodytemp
U = u0 + uk*(watertemp-(wmax+wmin)/2)

# sharks track their own temperature
v0 = 1.4  #average swim speed (prey is always 1.0)
vk = 0.2 #influence of bodytemp
V = v0 + vk*(sharktemp-(wmax+wmin)/2)

# calc light effect, or predation efficiency
#    e.g., in muddy (inclear) water this value will increase?
l0 = 1.0
l1 = 1.0
L = calc.light_effect(t,l0,l1)

#plot.assumption(t, watertemp, sharktemp, V, U, L)

x.seq = seq(0.0,1.5,length=5)
y.seq = seq(0.0,0.75,length=5)
par(mfrow=c(5,5),mex=0.4)
for(my in rev(y.seq)){
for(mx in x.seq){
	Ans = tss_probforage_energygain_optimize_linear(V, U, alpha, C, L, my, phi, omega, beta, h, mb,mx)
	plot.sim_result(Ans,bquote(list('m'['x']==.(mx),'m'['y']==.(my))))
}
}


par(mfrow=c(1,1))
grid = 51
no = matrix(0,grid,grid)
x.ax = seq(0,2,length=grid)
y.ax = seq(0,1,length=grid)

mx = 1.0
my = 1.0
for(y in 1:length(y.ax)){
	for(x in 1:length(x.ax)){
		mx = x.ax[x]
		my = y.ax[y]
		Ans = tss_probforage_energygain_optimize_linear(V, U, alpha, C, L, my, phi, omega, beta, h, mb,mx)
		no[x,y] = allpeak_no.sim_result(Ans,0.0)
		#	plot.sim_result(Ans,"")
	}
}

mode = allpeak_no.mode(no)
allpeak_no.image(x.ax,y.ax,mode,xlab="mx",ylab="my")
allpeak_no.point(x.ax,y.ax,mode,cex=0.5)

```


```{r phi_v0, echo=FALSE}

#=== plot with changing mass (sharkradius) and phi ===
omega = 1.0
beta = 1.0
phi = 0.2
h = 1.0

# work out the shark's body temperature
#    mass is kind of the size of shark (like sharkradius)
#    I used this just for simplifying parameters
mass = 10
sharktemp=calc.bodytemp(watertemp,mass) 
#bodytemp=calc.shark.temp(tnum,watertemp,sharkradius,skinthickness)

# prey immediately track temperature
uk = 0.2 #influence of bodytemp
U = u0 + uk*(watertemp-(tmax+tmin)/2)

# sharks track their own temperature
v0 = 1.4 #average swim speed (prey is always 1.0)
vk = 0.2 #influence of bodytemp
V = v0 + vk*(sharktemp-(tmax+tmin)/2)

# calc light effect, or predation efficiency
#    e.g., in muddy (inclear) water this value will increase?
l0 = 1
l1 = 1
L = calc.light_effect(t,l0,l1)

mx = 0.5
my = 0.5

#plot.assumption(t,watertemp,sharktemp, V,U,L)

mass=10
grid = 51
no = matrix(0,grid,grid)
x.ax = seq(0,0.4,length=grid)
y.ax = seq(1.0,2.0,length=grid)

for(y in 1:length(y.ax)){
	for(x in 1:length(x.ax)){
		phi  = x.ax[x]
		v0 = y.ax[y]
		
		sharktemp=calc.bodytemp(watertemp,mass) 
		V = v0 + vk*(sharktemp-(tmax+tmin)/2)
		
		Ans = tss_probforage_energygain_optimize_linear(V, U, alpha, C, L, my, phi, omega, beta, h, mb,mx)
		no[x,y] = allpeak_no.sim_result(Ans,0.0)
		#	plot.sim_result(Ans,"")
	}
}
par(mfrow=c(1,1))
mode = allpeak_no.mode(no)
allpeak_no.image(x.ax,y.ax,mode,xlab="phi",ylab="v0")
allpeak_no.point(x.ax,y.ax,mode,cex=0.5)

```

The phi has strong influence on results. Under small phi, the shark activity pattern is "until mid night" pattern, i.e., beforenoon to midnight (red), aftenoon to midnight (blue) and midnight (darkblue).  

Under large phi, the shark activity pattern is "around beforenoon" pattern, i.e., late afternoon to early aftenoon (yellowgreen), afternoon to beforenoon (cyan) and midnight to befornonn (light green).  
